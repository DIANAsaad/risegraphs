<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Flow, BOD, and TSS Trend Example</title>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #ffffff;
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
        box-sizing: border-box;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* ===== ADDITION ONLY (no changes to your existing rules) ===== */
      #layout {
        width: 100%;
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      #graph-wrap {
        flex: 1 1 auto;
        min-width: 0;
        display: flex;
      }
      #interpretation {
        width: 320px;
        flex: 0 0 320px;
        padding: 12px 14px;
        font-size: 14px;
        line-height: 1.4;
        margin-top: 5rem;
        color: #000;
        box-sizing: border-box;
      }

      /* ✅ FIX: on small screens, do NOT force 100vh;
         instead let Plotly have room for title + legend */
      @media (max-width: 1000px) {
        html,
        body {
          height: auto;
          min-height: 100%;
        }

        body {
          display: block;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }

        #layout {
          flex-direction: column;
          align-items: center;
        }
        #interpretation {
          width: 100%;
          flex: 0 0 auto;
          margin-top: 0.1rem;
        }
        #graph-wrap {
          width: 90%;
          display: flex;
          justify-content: center;
          align-items: center;
        }

        /* (UNCHANGED) */
        #chart {
          width: 100%;
          height: 70vh;
          min-height: 520px;
        }
      }

      /* ✅ NEW: mobile class tweaks (NO chart height changes) */
      body.is-mobile #container {
        padding: 8px; /* helps prevent “everything feels crushed” */
      }
      body.is-mobile #graph-wrap {
        width: 100%;
      }
      body.is-mobile #interpretation {
        padding: 10px 12px;
        font-size: 13px;
      }
      /* ===== END ADDITION ONLY ===== */

      #chart {
        width: 90%;
        height: 100vh;
        min-height: 420px;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <!-- ===== ADDITION ONLY (wrapper + interpretation) ===== -->
      <div id="layout">
        <div id="graph-wrap">
          <div id="chart"></div>
        </div>

        <div id="interpretation">
          <strong>Interpretation</strong><br /><br />
          <ul>
            <li>Flow shows a steady increase over several days.</li>
            <li>
              Effluent BOD and TSS do not improve as expected and begin to rise.
            </li>
            <li>
              Values approach the upper end of typical secondary effluent ranges
              (near the 30/30 benchmark).
            </li>
            <li>
              This suggests the process is under hydraulic stress, but not in
              immediate failure.
            </li>
            <li>
              The trend indicates reduced treatment efficiency as flow
              increases, likely due to reduced detention time or clarifier
              loading.
            </li>
            <li>
              While this behavior can be normal with higher flows, continued
              upward trends may lead to permit compliance risk if conditions
              persist.
            </li>
          </ul>
        </div>
      </div>
      <!-- ===== END ADDITION ONLY ===== -->
    </div>

    <script>
      const chartEl = document.getElementById("chart");

      // X-axis (Time)
      const days = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

      // Flow (Left Y-axis)
      const flowTrace = {
        x: days,
        y: [2.5, 2.65, 2.70, 2.95, 3.00, 3.2, 3.35, 3.40, 3.6, 3.70],
        name: "Flow (MGD)",
        type: "scatter",
        mode: "lines+markers",
        line: { width: 3, color: "#ff9287" },
        marker: { size: 8, color: "#ff9287" },
        hovertemplate:
          "<b>Flow</b><br>" +
          "Day: %{x}<br>" +
          "Flow: %{y:.2f} MGD<extra></extra>",
      };

      // Effluent BOD (Right Y-axis)
      const bodTrace = {
        x: days,
        y: [14, 15, 16, 17, 18, 19, 23, 26, 28, 32],
        name: "Effluent BOD (mg/L)",
        type: "scatter",
        mode: "lines+markers",
        yaxis: "y2",
        line: { width: 3, color: "#ff4500" },
        marker: { size: 8, color: "#ff4500" },
        hovertemplate:
          "<b>Effluent BOD</b><br>" +
          "Day: %{x}<br>" +
          "BOD: %{y} mg/L<extra></extra>",
      };

      // Effluent TSS (Right Y-axis)
      const tssTrace = {
        x: days,
        y: [12, 12.5, 13, 14, 15, 15.5, 20, 24, 27, 35],
        name: "Effluent TSS (mg/L)",
        type: "scatter",
        mode: "lines+markers",
        yaxis: "y2",
        line: { width: 3, color: "#8da2db" },
        marker: { size: 8, color: "#8da2db" },
        hovertemplate:
          "<b>Effluent TSS</b><br>" +
          "Day: %{x}<br>" +
          "TSS: %{y} mg/L<extra></extra>",
      };

      const layout = {
        title: { text: "<b>Flow, BOD, and TSS Trends Over Time</b>", x: 0.5 },

        hovermode: "x unified",
        hoverlabel: {
          bgcolor: "white",
          bordercolor: "black",
          font: { size: 13, color: "black" },
        },

        margin: { l: 80, r: 80, t: 150, b: 100 },

        plot_bgcolor: "#ffffff",
        paper_bgcolor: "#ffffff",
        font: { color: "#000000" },

        xaxis: {
          title: { text: "Time (Days)", standoff: 12 },
          dtick: 1,
          showline: true,
          linewidth: 2,
          automargin: true,
        },

        yaxis: {
          title: { text: "Flow (MGD)", standoff: 12 },
          showline: true,
          showgrid: false,
          linewidth: 2,
          automargin: true,
          dtick:0.1,
        },

        yaxis2: {
          title: { text: "Effluent Quality (mg/L)", standoff: 12 },
          overlaying: "y",
          side: "right",
          showline: true,
          showgrid: false,
          linewidth: 2,
          automargin: true,
          dtick:2,
        },

        // Default: legend ABOVE (desktop)
        legend: {
          orientation: "h",
          x: 0.5,
          xanchor: "center",
          y: 1.1,
          yanchor: "bottom",
          yref: "paper",
        },
      };

      const config = {
        responsive: true,
        displayModeBar: true,
      };

      // ✅ NEW: 3-tier behavior:
      // Desktop: >1000 (legend above)
      // Medium: 601–1000 (legend below, with safer spacing so it doesn't collide with title)
      // Mobile: <=600 (legend below + tighter margins so plot area stays readable WITHOUT changing chart height)
      function updateLegendPosition() {
        const w = window.innerWidth;

        const isMedium = w <= 1000;
        const isMobile = w <= 600;

        // add/remove mobile class (requested)
        document.body.classList.toggle("is-mobile", isMobile);

        if (isMobile) {
          Plotly.relayout(chartEl, {
            legend: {
              orientation: "h",
              x: 0.5,
              xanchor: "center",
              y: -0.35,
              yanchor: "top",
            },
            title: {
              text: "<b>Flow, BOD, and TSS Trends Over Time</b>",
              x: 0.5,
              y: 0.98,
              yanchor: "top",
            },
            // tighten margins so the plotting area isn't “tiny”
            // (this does NOT change chart height; it just gives the plot more usable space)
            margin: { l: 70, r: 70, t: 120, b: 170 },
          });
          return;
        }

        if (isMedium) {
          Plotly.relayout(chartEl, {
            legend: {
              orientation: "h",
              x: 0.5,
              xanchor: "center",
              y: -0.25,
              yanchor: "top",
            },
            // keep title high and stable so legend never overlaps it
            title: {
              text: "<b>Flow, BOD, and TSS Trends Over Time</b>",
              x: 0.5,
              y: 0.98,
              yanchor: "top",
            },
            // give title room without stealing too much from the plot
            margin: { l: 80, r: 80, t: 150, b: 140 },
          });
          return;
        }

        // Desktop
        Plotly.relayout(chartEl, {
          legend: {
            orientation: "h",
            x: 0.5,
            xanchor: "center",
            y: 1.1,
            yanchor: "bottom",
          },
          title: {
            text: "<b>Flow, BOD, and TSS Trends Over Time</b>",
            x: 0.5,
            y: 0.95,
          },
          margin: { l: 80, r: 80, t: 150, b: 100 },
        });
      }

      function stabilizeLayout() {
        Plotly.Plots.resize(chartEl);
        updateLegendPosition();
      }

      Plotly.newPlot(
        chartEl,
        [flowTrace, bodTrace, tssTrace],
        layout,
        config
      ).then(() => {
        setTimeout(stabilizeLayout, 0);
        setTimeout(stabilizeLayout, 120);
        setTimeout(stabilizeLayout, 400);
        setTimeout(stabilizeLayout, 900);
      });

      // Resize handling (RISE-safe)
      window.addEventListener("resize", stabilizeLayout);

      const ro = new ResizeObserver(() => stabilizeLayout());
      ro.observe(document.getElementById("container"));
    </script>
  </body>
</html>
