<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Double Y-Axis Operator Graph</title>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
      :root {
        --gap: 16px;
        --pad: 10px;
        --note-gap: 10px;
      }

      html,
      body {
        height: 100%;
        margin: 0;
      }

      body {
        font-family: Arial, sans-serif;
        background: #fff;
        overflow: auto;
      }

      #wrapper {
        height: 100%;
        min-height: 100%;
        box-sizing: border-box;
        display: flex;
        align-items: stretch;
        gap: var(--gap);
        padding: var(--pad);
      }

      #leftcol {
        flex: 1 1 560px;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      /* MAIN CHART */
      #chart {
        width: 100%;
        height: 440px;
        max-height: 560px;
        min-height: 300px;
      }

      /* NOTE */
      #note {
        flex: 0 0 auto;
        margin-top: var(--note-gap);
        margin-bottom: 0; /* IMPORTANT: prevents extra gap before interpretation when stacked */
        padding: 10px 14px 10px 6px;
        font-size: 14px;
        color: #000;
        line-height: 1.35;
      }

      /* RIGHT COLUMN */
      #interpretation {
        flex: 0 0 360px;
        min-width: 280px;
        max-width: 420px;
        padding: 12px 14px;
        font-size: 14px;
        color: #000;
        line-height: 1.4;
        overflow: auto;
        box-sizing: border-box;
      }

      /* mini chart */
      #miniWrap {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #ddd;
      }
      #miniTitle {
        font-size: 13px;
        margin: 0 0 8px 0;
        color: #000;
      }
      #miniChart {
        width: 100%;
        height: 220px;
      }

      /* STACKED (mobile/tablet) */
      @media (max-width: 900px) {
        :root {
          --gap: 3px;     /* tighter */
          --pad: 6px;     /* tighter */
          --note-gap: 4px; /* tighter note spacing */
        }

        #wrapper {
          height: auto;
          flex-direction: column;
          margin-bottom: 0;
        }

        #chart {
          height: 380px;
          max-height: 480px;
        }

        /* KEY FIX for the “huge space”:
           remove any chance of extra margins/padding between leftcol and interpretation */
        #leftcol {
          margin-bottom: 0;
          padding-bottom: 0;
        }

        #note {
          margin-top: 4px;
          margin-bottom: 0px; /* tiny gap before interpretation */
          padding-top: 8px;
          padding-bottom: 0px;
        }

        #interpretation {
          width: 100%;
          max-width: none;
          padding-top: 0px;   /* tighter */
          padding-bottom: 8px;
          margin-top: 0;      /* IMPORTANT: no extra gap */
        }

        #miniChart {
          height: 200px;
        }
      }
    </style>
  </head>

  <body>
    <div id="wrapper">
      <div id="leftcol">
        <div id="chart"></div>

        <div id="note">
          <b>NOTE:</b> To hide one of the graphs, click its label in the legend.
        </div>
      </div>

      <div id="interpretation">
        <b>Interpretation of the graph</b><br /><br />
        This graph uses a <b>double Y-axis</b> to compare changes in chemical
        dosing with changes in effluent quality over time.<br /><br />

        • The <b>right Y-axis</b> represents <b>Chemical Dose (mg/L)</b>, shown
        by the <b>orange line</b>. As the days progress, the chemical dose
        increases steadily.<br /><br />

        • The <b>left Y-axis</b> represents <b>Effluent TSS (mg/L)</b>, shown by
        the <b>black line</b>. Over the same time period, effluent TSS decreases
        consistently.<br /><br />

        • The opposite trends indicate an <b>inverse relationship</b>: as
        chemical dose increases, effluent TSS decreases, suggesting improved
        solids removal performance.<br /><br />

        <div id="miniWrap">
          <div id="miniTitle">
            <b>Extra example (mini chart):</b> Flow (MGD) vs Effluent Turbidity
            (NTU)
          </div>
          <div id="miniChart"></div>
        </div>
      </div>
    </div>

    <script>
      /* ===================== MAIN CHART ===================== */
      const days = [1, 2, 3, 4, 5, 6];
      const effluentTSS = [150, 120, 110, 100, 90, 80];
      const chemicalDose = [0, 5, 10, 13, 15, 18];

      const tssTrace = {
        x: days,
        y: effluentTSS,
        name: "Effluent TSS (mg/L)",
        yaxis: "y",
        type: "scatter",
        mode: "lines+markers",
        line: { color: "black" },
        hovertemplate:
          "<b>Effluent TSS</b><br>" +
          "Day: %{x}<br>" +
          "TSS: %{y} mg/L<extra></extra>",
      };

      const doseTrace = {
        x: days,
        y: chemicalDose,
        name: "Chemical Dose (mg/L)",
        yaxis: "y2",
        type: "scatter",
        mode: "lines+markers",
        line: { color: "#ff4500" },
        hovertemplate:
          "<b>Chemical Dose</b><br>" +
          "Day: %{x}<br>" +
          "Dose: %{y} mg/L<extra></extra>",
      };

      const layout = {
        autosize: true,
        plot_bgcolor: "white",
        paper_bgcolor: "white",
        title: {
          text: "<b>Chemical Dose vs Effluent TSS (Double Y-Axis)</b>",
          font: { color: "black" },
        },

        /* We'll dynamically change bottom margin for legend-on-bottom */
        margin: { l: 80, r: 60, t: 60, b: 70 },
        font: { color: "black" },

        xaxis: {
          title: "Time (Days)",
          dtick: 1,
          zeroline: false,
          showline: true,
          linewidth: 2,
        },

        yaxis: {
          title: "Effluent TSS (mg/L)",
          range: [0, 170],
          dtick: 10,
          showgrid: false,
          zeroline: false,
          showline: true,
          linewidth: 2,
        },

        yaxis2: {
          title: "Chemical Dose (mg/L)",
          range: [0, 20],
          dtick: 5,
          overlaying: "y",
          side: "right",
          showgrid: false,
          zeroline: false,
          showline: true,
          linewidth: 2,
        },

        legend: {
          orientation: "v",
          x: 1,
          y: 1,
          xanchor: "right",
          yanchor: "top",
          font: { size: 12, color: "black" },
          bgcolor: "rgba(255,255,255,0.85)",
        },

        hovermode: "closest",
      };

      const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: [
          "toImage",
          "select2d",
          "lasso2d",
          "autoScale2d",
          "toggleSpikelines",
        ],
      };

      /* ===================== MINI CHART ===================== */
      const miniDays = [1, 2, 3, 4, 5, 6];
      const flowMGD = [2.1, 2.4, 2.8, 3.2, 3.0, 2.6];
      const turbNTU = [7.5, 7.0, 6.2, 8.8, 9.6, 7.9];

      const flowTrace = {
        x: miniDays,
        y: flowMGD,
        name: "Flow (MGD)",
        type: "scatter",
        mode: "lines+markers",
        line: { color: "#1f77b4" },
        hovertemplate: "<b>Flow</b><br>Day: %{x}<br>%{y} MGD<extra></extra>",
      };

      const turbTrace = {
        x: miniDays,
        y: turbNTU,
        name: "Turbidity (NTU)",
        yaxis: "y2",
        type: "scatter",
        mode: "lines+markers",
        line: { color: "#ff4500" },
        hovertemplate:
          "<b>Turbidity</b><br>Day: %{x}<br>%{y} NTU<extra></extra>",
      };

      const miniLayout = {
        autosize: true,
        plot_bgcolor: "white",
        paper_bgcolor: "white",
        margin: { l: 50, r: 55, t: 35, b: 45 },
        font: { color: "black", size: 11 },
        xaxis: { title: "Day", dtick: 1, zeroline: false, showline: true },
        yaxis: {
          title: "Flow (MGD)",
          range: [1.8, 3.6],
          dtick: 0.4,
          showgrid: false,
          zeroline: false,
          showline: true,
        },
        yaxis2: {
          title: "Turbidity (NTU)",
          range: [5, 11],
          dtick: 1,
          overlaying: "y",
          side: "right",
          showgrid: false,
          zeroline: false,
          showline: true,
        },
        legend: {
          orientation: "h",
          x: 0.5,
          y: 1.15,
          xanchor: "center",
          yanchor: "bottom",
          font: { size: 10, color: "black" },
          bgcolor: "rgba(255,255,255,0.85)",
        },
        hovermode: "closest",
      };

      const miniConfig = { responsive: true, displayModeBar: false };

      /* ===================== RESPONSIVE (LEGEND GOES DOWN ON SMALL) ===================== */
      const wrapperEl = document.getElementById("wrapper");
      const chartEl = document.getElementById("chart");
      const miniChartEl = document.getElementById("miniChart");

      function getContainerWidth() {
        return wrapperEl ? wrapperEl.clientWidth : window.innerWidth;
      }

      function applyLegendForContainer() {
        const w = getContainerWidth();
        const isNarrow = w <= 900;

        // IMPORTANT: on narrow => legend BELOW chart with spacing
        const updates = isNarrow
          ? {
              "legend.orientation": "h",
              "legend.x": 0,
              "legend.y": -0.25,       // below plot
              "legend.xanchor": "left",
              "legend.yanchor": "top",
              "margin.b": 130,         // space for legend
              "margin.t": 60,
              "margin.r": 60,
            }
          : {
              "legend.orientation": "v",
              "legend.x": 1,
              "legend.y": 1,
              "legend.xanchor": "right",
              "legend.yanchor": "top",
              "margin.b": 70,
              "margin.t": 60,
              "margin.r": 60,
            };

        Plotly.relayout(chartEl, updates);
      }

      let rafId = null;
      function scheduleResize() {
        if (rafId) cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(() => {
          applyLegendForContainer();
          Plotly.Plots.resize(chartEl);
          Plotly.Plots.resize(miniChartEl);
        });
      }

      function setupResizeObserver() {
        if (!("ResizeObserver" in window)) return;
        const ro = new ResizeObserver(scheduleResize);
        ro.observe(wrapperEl);
      }

      Promise.all([
        Plotly.newPlot(chartEl, [tssTrace, doseTrace], layout, config),
        Plotly.newPlot(miniChartEl, [flowTrace, turbTrace], miniLayout, miniConfig),
      ]).then(() => {
        setupResizeObserver();
        window.addEventListener("resize", scheduleResize);

        // Rise/iframe stabilization
        setTimeout(scheduleResize, 0);
        setTimeout(scheduleResize, 120);
        setTimeout(scheduleResize, 400);
      });
    </script>
  </body>
</html>
